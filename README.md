# Case Simulator

Полный README для GitHub: здесь описано, как пользоваться проектом, как добавлять контент,
и как запускать симуляции и отчёты.

Если вы — пользователь: следуйте секции "Быстрый старт". Если вы — разработчик,
перейдите к разделам "Разработка" и "Добавление контента".

---

## Содержание

- О проекте
- Особенности
- Быстрый старт
- Установка и зависимости
- Добавление предметов и кейсов (контент)
- Система качества (quality) 
- _Скрипт симуляции и отчёты (for develop only)_
- Структура проекта и разработка
- Тестирование
- Вклад и Контакты
- Лицензия

---

## О проекте

`Case Simulator` — консольный симулятор открытия кейсов, магазина и инвентаря.
Проект удобен для:

- Быстрой проверки экономических изменений (цены, редкости, шансы).
- Анализа статистики выпадений и качества предметов.
- Разработки и тестирования механик кейсов и предметов.

Проект не требует внешних сервисов и работает локально.

## Особенности

- Пер-instance quality — каждая выпавшая копия предмета имеет своё `quality`.
- Магазин со стандартной витриной, поддержка покупки кейсов и предметов.
- Grant-once пресеты — возможность раздать бесплатные кейсы игрокам один раз.
- Скрипт симуляции с подробным отчётом: среднее качество, std и редкие бэнды.
- Автоматическая агрегация контента в `case_simulator/data/presets.py`.

## Быстрый старт

1. Клонируйте репозиторий и перейдите в директорию проекта:

```powershell
git clone <repo-url>
cd hitt
```

2. (Опционально) создайте виртуальное окружение:

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

3. Запуск приложения:

```powershell
python main.py
```

4. Быстрая симуляция выпадений (пример):

```powershell
python scripts/run_simulation.py
```

Отчёты будут записаны в `reports/` (если включено) и напечатаны в консоль.

## Установка и зависимости

Текущая версия не использует внешних зависимостей (только стандартная библиотека).
Если в будущем появится `requirements.txt`, установите зависимости командой:

```powershell
pip install -r requirements.txt
```

## Добавление предметов и кейсов (контент)

Все предметы и кейсы находятся в `case_simulator/data/presets.py`.

- Добавление предмета:

```python
MY_GUN = Item(id="my_gun", name="My Gun", price=1200, category="pistol", rare=3)
```

- Добавление кейса вручную:

```python
MY_CASE = Case(id="my_case", name="My Case", price=250, items=(MY_GUN, OTHER_ITEM))
```

- Автоматическая агрегация:

  Файл `presets.py` содержит код, который собирает все объявленные `Item`-объекты
  в список `ITEMS` и все `Case` — в `CASES`. Если вы добавляете новые переменные,
  убедитесь, что они объявлены до этого блока. Если предпочитаете, могу переместить
  сбор в конец файла — скажите.

## Система качества (quality)

Ключевая механика: при выпадении каждого предмета ему присваивается `quality` —
вещественное число в диапазоне [0.0, 1.0] с 6 знаками точности.

- Генерация: `case_simulator/utils/quality.py::gen_quality()` — бета-распределение
  с дополнениями для редких бэндов.
- Использование: `quality` сохраняется в инвентаре и влияет на цену при продаже через
  `case_simulator/utils/pricing.py::price_multiplier(q)`.
- Редкие бэнды, которые используются в отчётах: >=0.99, >=0.9951, >=0.9990.

Если нужно скорректировать среднее/хвост генерации, измените параметры beta в
`quality.py`.

## Крафт (Crafting)

В проект добавлена простая система крафта предметов. Ниже — ключевые правила и заметки по использованию:

- Режимы крафта: probabilistic (вероятностный апгрейд), deterministic (гарантированный обмен/слияние), fusion (слияние нескольких предметов в новый) и upgrade (попытка улучшить предмет).
- Входные предметы при попытке крафта "сгорают" (удаляются) — если режим предусматривает вероятность неуспеха, то в случае неудачи новый предмет не создаётся и входы теряются.
- Если все выбранные для крафта предметы принадлежат к одной категории, результат будет ограничен этой же категорией (категория сохраняется).
- Новый предмет получает сгенерированное качество (quality) — качество входных предметов не переносится напрямую на итоговый предмет.
- Выбор шаблона результата (template) основан на скорректированной цене с учётом сгенерированного качества (adjusted price = base_price * price_multiplier(q)).
- Стоимость крафта рассчитывается от суммы скорректированных цен входов и равна 0.2% от этой суммы: cost = max(1, round(adjusted_sum * 0.002)). Минимальная стоимость равна 1 единице валюты.
- В интерфейсе выбора предметов для крафта не показываются id и базовая цена — отображается только скорректированная цена (adj) и качество (качество/quality).
- После успешного крафта в инвентарь добавляется только созданный предмет; в случае неудачи предмет не добавляется (входы уже сгорели).
- Перед выбором режима крафта есть краткий гайд по режимам (в интерфейсе доступен пункт "гайд"), он поясняет отличия режимов и риски.

Эти правила влияют на баланс и экономику — для массовых симуляций рекомендуем запускать `scripts/run_simulation.py` или отдельные тесты, чтобы оценить ожидаемый P/L по каждому режиму.

## _Скрипт симуляции и отчёты_

_Скрипт `scripts/run_simulation.py` использует `tools/simulate_drops.simulate()` и_
_генерирует подробный отчёт по предметам:_

- _Количество выпадений и эмпирические вероятности_
- _Среднее и стандартное отклонение `quality` по предмету_
- _Количество выпадений в каждом редком бэнде_

_Файл отчёта сохраняется в `reports/drop_report_<timestamp>.txt`._

_Тестовый режим: уменьшите `trials` в скрипте для быстрой проверки (пример: 100_000)._

## Структура проекта (важные файлы)

- `main.py` — точка входа для игры
- `case_simulator/app.py` — инициализация и сцены
- `case_simulator/models/` — модели `Item`, `Case`, `Inventory`
- `case_simulator/scenes/` — сцены (menu, case_opening, shop, inventory)
- `case_simulator/utils/` — утилиты (`quality.py`, `pricing.py`, `console.py`)
- `case_simulator/data/presets.py` — контент (items, cases)
- `case_simulator/save_manager.py` — сохранение/загрузка прогресса
- _`scripts/run_simulation.py` — генерация статистических отчётов_

## Разработка и тестирование

Предложения по развитию:

- Добавить `requirements.txt` и CI (GitHub Actions) для автоматического запуска
  симуляций и тестов.
- Добавить unit-tests (pytest) для `quality`, `pricing` и основных моделей.

Ручная проверка при правках контента:

```powershell
python -c "import importlib; m=importlib.import_module('case_simulator.data.presets'); print('ITEMS=', len(m.ITEMS), 'CASES=', [c.id for c in m.CASES])"
```

## Вклад

1. Форкните репозиторий и создайте ветку с понятным именем.
2. Добавьте изменения и тесты (если нужно).
3. Откройте Pull Request с описанием изменений и причинами.

Для изменений, затрагивающих экономику/шансы, приложите небольшой отчёт симуляции
с результатами (например, `reports/drop_report_xxx.txt`). Это ускорит ревью.

## Лицензия

Добавьте файл `LICENSE` (рекомендуется MIT). Если хотите, помогу подготовить
текст лицензии.

---

Если хотите — я могу также добавить английскую версию `README.md` и / или
подробную документацию `DOCUMENTATION.md` и `docs/`.
